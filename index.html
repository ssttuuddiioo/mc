<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Orbit Demo - SVG Placement Tool</title>
  <link rel="stylesheet" href="style.css?v=1.0.1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet">
  
  <!-- Custom Font -->
  <style>
    @font-face {
      font-family: 'MichiganCentralMonumentGrotesk-Bold';
      src: url('public/fonts/MichiganCentralMonumentGrotesk-Bold.woff2?v=1.0.1') format('woff2'),
           url('public/fonts/MichiganCentralMonumentGrotesk-Bold.woff?v=1.0.1') format('woff'),
           url('public/fonts/MichiganCentralMonumentGrotesk-Bold.ttf?v=1.0.1') format('truetype');
      font-weight: bold;
      font-display: swap;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- TEST BUTTON FOR ADMIN PANEL (HIDDEN) -->
  <button id="test-admin-button" style="display: none;">
    üõ†Ô∏è OPEN ADMIN PANEL (TEST)
  </button>
  
  <script>
    // Register Service Worker for offline functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('‚úÖ Service Worker registered:', registration.scope);
          })
          .catch(error => {
            console.log('‚ùå Service Worker registration failed:', error);
          });
      });
    }

    // Simple direct function to open admin panel
    function openAdminPanelTest() {
      console.log('üõ†Ô∏è DIRECT TEST BUTTON CLICKED!');
      const panel = document.getElementById('admin-panel');
      console.log('üîç Panel found:', !!panel);
      
      if (panel) {
        panel.classList.remove('editor-hidden');
        panel.style.display = 'block';
        panel.style.visibility = 'visible';
        panel.style.opacity = '1';
        panel.style.transform = 'translateX(0)';
        panel.style.right = '0';
        console.log('‚úÖ Panel should be visible now');
      } else {
        console.error('‚ùå Panel not found');
      }
    }
    
    // Test function for Add New Marker
    function testAddNewMarker() {
      console.log('‚ûï ADD NEW MARKER CLICKED!');
      
      // Clear dropdown and set to "new" mode
      const select = document.getElementById('admin-marker-select');
      if (select) {
        select.innerHTML = '<option value="new">‚ûï Creating New Marker...</option>';
        select.value = 'new';
        console.log('‚úÖ Dropdown set to new mode');
      }
      
      // Show the edit section
      const editSection = document.getElementById('admin-edit-section');
      if (editSection) {
        editSection.style.display = 'block';
        console.log('‚úÖ Edit section shown');
      }
      
      // Clear form fields
      const fields = [
        'admin-marker-name', 'admin-marker-lat', 'admin-marker-lng', 
        'admin-marker-color', 'admin-marker-short-desc', 'admin-marker-description',
        'admin-marker-size', 'admin-marker-address', 'admin-marker-image', 'admin-marker-features'
      ];
      
      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.value = '';
        }
      });
      
      // Set default color
      const colorField = document.getElementById('admin-marker-color');
      if (colorField) {
        colorField.value = '#4A90E2';
      }
      
      console.log('‚úÖ Form cleared and ready for new marker');
    }
  </script>
  
  <!-- PRECISION CROSSHAIR OVERLAY -->
  <div id="precision-crosshair" style="display: none;">
    <div class="crosshair-h"></div>
    <div class="crosshair-v"></div>
    <div class="precision-coords">
      <span id="live-coords">0.000000, 0.000000</span>
      <span id="precision-mode">NORMAL</span>
    </div>
  </div>

  <!-- Style Controls in Top-Left (HIDDEN) -->
  <div id="style-controls" style="display: none;">
    <button data-style="mapbox://styles/mapbox/light-v11" title="Light Mode">‚òÄÔ∏è</button>
    <button data-style="mapbox://styles/mapbox/standard" title="Standard Mode">üó∫Ô∏è</button>
    <button id="svg-editor-toggle" title="SVG Placement Tool">‚öôÔ∏è</button>
    <button id="admin-panel-toggle" title="Admin Panel">üõ†Ô∏è</button>
  </div>
  
  <!-- Precision Mode Status -->
  <div id="precision-status" style="position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 12px; z-index: 1000; display: none;">
    <div id="mode-indicator">NORMAL MODE</div>
    <div id="controls-hint" style="font-size: 10px; opacity: 0.7; margin-top: 4px;">Press C for crosshair, Ctrl+P for help</div>
  </div>

  <!-- Online/Offline Status Indicator -->
  <div id="connection-status" style="position: fixed; top: 20px; right: 20px; background: rgba(46, 204, 113, 0.9); color: white; padding: 6px 12px; border-radius: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 11px; font-weight: 500; z-index: 1001; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
    <span id="connection-icon">üåê</span>
    <span id="connection-text">Online</span>
    <span id="cache-info" style="font-size: 9px; opacity: 0.8; margin-left: 8px;"></span>
  </div>

  <!-- Legend Toggle Button (HIDDEN) -->
  <button id="legend-toggle" style="display: none;">üìç</button>

  <!-- Legend Panel -->
  <div id="legend" class="legend-hidden">
    <div class="legend-header">
      <h3>Locations</h3>
      <button id="close-legend-btn">‚úï</button>
    </div>
    <div class="legend-content">
      <button class="legend-item" data-location="rooseveltPark">Roosevelt Park</button>
      <button class="legend-item" data-location="michiganCentral">Michigan Central</button>
      <button class="legend-item" data-location="campusMartius">Campus Martius</button>
      <button class="legend-item" data-location="newlab">The Factory</button>
    </div>
  </div>

  <!-- Building Settings Panel (Hidden) -->
  <div id="building-settings" class="editor-hidden">
    <div class="editor-header">
      <h3>Building Highlight Settings</h3>
      <div id="building-mode-indicator">üè¢ Light Mode Only</div>
      <button id="close-building-settings-btn">‚úï</button>
    </div>
    <div class="editor-content">
      <div class="editor-section">
        <label>Target Building:</label>
        <select id="building-target-select">
          <option value="michiganCentral">Michigan Central Station</option>
        </select>
      </div>
      <div class="editor-section">
        <label>Highlight Color:</label>
        <input type="color" id="building-color" value="#0066ff">
        <div class="color-preview" id="color-preview"></div>
      </div>
      <div class="editor-section">
        <label>Opacity: <span id="building-opacity-value">0.8</span></label>
        <input type="range" id="building-opacity" min="0.1" max="1.0" step="0.1" value="0.8">
      </div>
      <div class="editor-section">
        <label>Enable Highlighting:</label>
        <input type="checkbox" id="building-highlight-enabled" checked>
        <span>Only works in Light Mode</span>
      </div>
      <div class="editor-actions">
        <button id="apply-building-settings">Apply Settings</button>
        <button id="reset-building-settings">Reset to Default</button>
      </div>
    </div>
  </div>

  <!-- SVG Editor Panel - Redesigned for Logical Workflow -->
  <div id="svg-editor" class="editor-hidden">
    <div class="editor-header">
      <h3>SVG Placement Tool</h3>
      <div id="edit-mode-indicator">
        <span id="current-svg-indicator">No SVG Selected</span>
      </div>
      <button id="close-editor-btn">‚úï</button>
    </div>
    <div class="editor-content">
      
      <!-- Step 1: File Selection -->
      <div class="workflow-step">
        <div class="step-header">
          <span class="step-number">1</span>
          <h4>Select SVG File</h4>
        </div>
        <div class="file-grid">
          <select id="svg-file-select" class="file-selector">
            <option value="">Loading SVG files...</option>
          </select>
          <button id="load-svg-btn" class="primary-btn" disabled>Load SVG</button>
        </div>
      </div>

      <!-- Step 2: Position & Transform -->
      <div class="workflow-step" id="placement-step" style="display: none;">
        <div class="step-header">
          <span class="step-number">2</span>
          <h4>Position & Transform</h4>
        </div>
        
        <!-- Quick Coordinate Input -->
        <div class="quick-coords">
          <label>Quick Coordinates (Google Maps format):</label>
          <div class="coord-input-row">
            <input type="text" id="google-coords" placeholder="42.3289, -83.0776">
            <button id="apply-coords-btn" class="secondary-btn">Apply</button>
          </div>
        </div>

        <!-- Precise Controls -->
        <div class="control-group">
          <div class="control-row">
            <label>Latitude <span id="lat-value" class="value-display">42.3289</span></label>
            <div class="input-group">
              <input type="number" id="lat-input" step="0.0000001" class="coord-input" value="42.3289" placeholder="42.3289">
              <input type="range" id="lat-slider" min="42.25" max="42.45" step="0.0000001" value="42.3289" class="coord-slider">
            </div>
          </div>
          
          <div class="control-row">
            <label>Longitude <span id="lng-value" class="value-display">-83.0776</span></label>
            <div class="input-group">
              <input type="number" id="lng-input" step="0.0000001" class="coord-input" value="-83.0776" placeholder="-83.0776">
              <input type="range" id="lng-slider" min="-83.15" max="-83.00" step="0.0000001" value="-83.0776" class="coord-slider">
            </div>
          </div>
          
          <div class="control-row">
            <label>Scale <span id="scale-value" class="value-display">1.0</span></label>
            <div class="input-group">
              <input type="number" id="scale-input" step="0.00001" min="0.00001" max="10" class="coord-input" value="1.0" placeholder="1.0">
              <input type="range" id="scale-slider" min="0.00001" max="10" step="0.00001" value="1.0" class="coord-slider">
            </div>
          </div>
          
          <div class="control-row">
            <label>Rotation <span id="rotation-value" class="value-display">0¬∞</span></label>
            <div class="input-group">
              <input type="number" id="rotation-input" step="0.00001" min="0" max="360" class="coord-input" value="0" placeholder="0">
              <input type="range" id="rotation-slider" min="0" max="360" step="0.00001" value="0" class="coord-slider">
            </div>
          </div>
        </div>

        <!-- Visual Controls -->
        <div class="visual-controls">
          <div class="control-row">
            <label>Color</label>
            <div class="input-group">
              <input type="color" id="color-input" class="color-picker-modern">
            </div>
          </div>
          <div class="control-row">
            <label>Opacity <span id="opacity-value" class="value-display">0.8</span></label>
            <div class="input-group">
              <input type="number" id="opacity-input" step="0.1" min="0" max="1" class="coord-input" value="0.8" placeholder="0.8">
              <input type="range" id="opacity-slider" min="0" max="1" step="0.1" value="0.8" class="coord-slider">
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Save & Continue -->
      <div class="workflow-step save-section" id="save-step" style="display: none;">
        <div class="step-header save-header">
          <span class="step-number">üíæ</span>
          <div class="header-text">
            <h4>Save & Continue</h4>
            <p class="step-description">Finalize your SVG placement or continue with another</p>
          </div>
        </div>
        <div class="action-buttons">
          <button id="save-svg-btn" class="success-btn">
            <span class="btn-icon">üíæ</span>
            <span class="btn-text">Save This SVG</span>
          </button>
          <button id="make-permanent-btn" class="permanent-btn">
            <span class="btn-icon">üåê</span>
            <span class="btn-text">Make Permanent</span>
          </button>
          <button id="save-and-next-btn" class="primary-btn">
            <span class="btn-icon">üíæ‚û°Ô∏è</span>
            <span class="btn-text">Save & Add Next</span>
          </button>
          <button id="discard-btn" class="danger-btn">
            <span class="btn-icon">üóëÔ∏è</span>
            <span class="btn-text">Discard Changes</span>
          </button>
        </div>
      </div>

      <!-- Placed SVGs List -->
      <div class="workflow-step">
        <div class="step-header">
          <span class="step-number">üìã</span>
          <h4>Placed SVGs (<span id="svg-count">0</span>)</h4>
        </div>
        <div id="placed-svgs-list" class="svg-list">
          <div class="no-svgs-message">No SVGs placed yet</div>
        </div>
        <button id="clear-all-svgs" class="danger-btn">Clear All SVGs</button>
      </div>
      
    </div>
  </div>

  <!-- Admin Panel for Marker Management -->
  <div id="admin-panel" class="editor-hidden">
    <div class="editor-header">
      <h3>Admin Panel - Marker Management</h3>
      <div id="admin-mode-indicator">üõ†Ô∏è Admin Mode</div>
      <button id="close-admin-panel-btn">‚úï</button>
    </div>
    <div class="editor-content">
      
      <!-- Marker Selection -->
      <div class="workflow-step">
        <div class="step-header">
          <span class="step-number">üìç</span>
          <h4>Select Marker to Edit</h4>
        </div>
        <div class="editor-section">
          <label>Marker ID:</label>
          <select id="admin-marker-select">
            <option value="">Select a marker...</option>
          </select>
          <button id="admin-add-new-marker" class="primary-btn" style="margin-left: 10px;" onclick="testAddNewMarker()">‚ûï Add New Marker</button>
        </div>
      </div>

      <!-- Marker Information Editor -->
      <div class="workflow-step" id="admin-edit-section" style="display: none;">
        <div class="step-header">
          <span class="step-number">‚úèÔ∏è</span>
          <h4>Edit Marker Information</h4>
        </div>
        
        <div class="editor-section">
          <label>Name:</label>
          <input type="text" id="admin-marker-name" placeholder="Marker name">
        </div>
        
        <div class="editor-section">
          <label>Category:</label>
          <select id="admin-marker-category">
            <option value="transportation">üöÇ Transportation/Logistics</option>
            <option value="manufacturing">üè≠ Manufacturing/Workshop</option>
            <option value="innovation">üöÄ Innovation/Technology</option>
            <option value="infrastructure">üèóÔ∏è Infrastructure/Transportation</option>
            <option value="future">üîÆ Future Development</option>
          </select>
        </div>
        
        <div class="editor-section">
          <label>Short Description:</label>
          <input type="text" id="admin-marker-short-desc" placeholder="Brief description">
        </div>
        
        <div class="editor-section">
          <label>Full Description:</label>
          <textarea id="admin-marker-description" rows="4" placeholder="Detailed description"></textarea>
        </div>
        
        <div class="editor-section">
          <label>Size:</label>
          <input type="text" id="admin-marker-size" placeholder="e.g. 10,000 sq ft">
        </div>
        
        <div class="editor-section">
          <label>Address:</label>
          <input type="text" id="admin-marker-address" placeholder="Full address">
        </div>
        
        <div class="editor-section">
          <label>Latitude:</label>
          <input type="number" id="admin-marker-lat" step="0.0000001" placeholder="42.3289">
        </div>
        
        <div class="editor-section">
          <label>Longitude:</label>
          <input type="number" id="admin-marker-lng" step="0.0000001" placeholder="-83.0776">
        </div>
        
        <div class="editor-section">
          <label>Color:</label>
          <input type="color" id="admin-marker-color" value="#4A90E2">
        </div>
        
        <div class="editor-section">
          <label>Image Path:</label>
          <input type="text" id="admin-marker-image" placeholder="public/about/image.jpg">
        </div>
        
        <div class="editor-section">
          <label>Features (one per line):</label>
          <textarea id="admin-marker-features" rows="5" placeholder="Feature 1
Feature 2
Feature 3"></textarea>
        </div>
        
        <div class="editor-section">
          <div id="admin-status-indicator" style="padding: 10px; margin: 10px 0; border-radius: 5px; display: none;">
            <span id="admin-status-text">Ready</span>
          </div>
        </div>
        
        <div class="editor-actions">
          <button id="admin-save-marker" class="success-btn">üíæ Save to Database</button>
          <button id="admin-delete-marker" class="danger-btn" style="display: none;">üóëÔ∏è Delete Marker</button>
          <button id="admin-reset-marker" class="secondary-btn">Reset</button>
          <button id="admin-export-data" class="primary-btn">Export All Data</button>
        </div>
      </div>
      
    </div>
  </div>

  <!-- Side Panel for Label Information -->
  <div id="label-info-panel" class="side-panel">
    <button id="close-panel" class="close-btn-overlay">√ó</button>
    
    <!-- Panel Content Container -->
    <div class="panel-container">
      <!-- Title Section -->
      <div class="panel-title-section">
        <h1 class="panel-title" id="location-title">Loading Location...</h1>
      </div>
      
      <!-- Hero Image with Category Badge -->
      <div class="panel-hero" id="location-image">
        <img id="location-photo" src="" alt="" style="display: none;">
        <div class="image-placeholder"></div>
        <div class="category-badge" id="location-category">LOADING...</div>
        <div class="stats-badges" id="location-stats">
          <div class="stats-badge">
            <span class="stats-icon">üè¢</span>
            <span id="building-floors">18 floors</span>
          </div>
          <div class="stats-badge">
            <span class="stats-icon">üìè</span>
            <span id="building-size">500K sq ft</span>
          </div>
        </div>
      </div>
      
      <!-- Description Section -->
      <div class="panel-section">
        <h2 class="section-title">Description</h2>
        <div class="description-content">
          <p id="location-description">Loading description...</p>
        </div>
      </div>
      
      <!-- Key Features Section -->
      <div class="panel-section">
        <h2 class="section-title">Key Features</h2>
        <div class="features-grid" id="location-features">
          <!-- Feature items will be dynamically inserted here -->
        </div>
      </div>
      
      <!-- Companies List Section -->
      <div class="panel-section" id="companies-section">
        <h2 class="section-title">Companies</h2>
        <div class="companies-grid" id="companies-list">
          <!-- Company items will be dynamically inserted here -->
        </div>
      </div>
    </div>
  </div>

  <script src="main.js?v=1.0.1"></script>
</body>
</html>